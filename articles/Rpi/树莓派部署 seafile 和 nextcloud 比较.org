#+TITLE: æ ‘è“æ´¾éƒ¨ç½² seafile å’Œ nextcloud æ¯”è¾ƒ
#+AUTHOR: é™³æ”¾ç‚º

* ç¼˜ç”±
å®¶ä¸­åˆšå¥½é—²ç½®äº†ä¸€å—ç§»åŠ¨ç¡¬ç›˜ï¼Œè¶³è¶³æœ‰2Tï¼Œè€Œä¸”ä¹Ÿæœ‰ä¸€å®šå¹´å¤´äº†ï¼Œä¸ç”¨ç™½ä¸ç”¨ï¼Œæ‹¿æ¥å¹²ç‚¹ä»€ä¹ˆä¹Ÿå¥½ï¼Œæƒ³äº†æƒ³ï¼Œè¿˜æœ‰ä¸€ä¸ªæ ‘è“æ´¾3Bï¼Œè¦ä¸æ­ä¸€ä¸ªç½‘ç›˜å§ã€‚

* æ€è·¯

1. ç½‘ç»œä¸Šå¼€æºçš„ç½‘ç›˜æœ‰å‡ ä¸ªï¼Œæˆ‘å¬è¯´è¿‡æ¯”è¾ƒå‡ºåçš„æ˜¯å›½å†…çš„ seafile å’Œå›½å¤–çš„ nextcloudï¼Œå°å­©å­æ‰æ¯”è¾ƒï¼Œæˆå¹´äººå…¨éƒ½è¦ï¼Œå†³å®šç›´æ¥æ­å»ºä¸¤ä¸ªï¼Œç”¨ä½œæ¯”è¾ƒ
2. æ ‘è“æ´¾é‚£é¸¡å„¿å¤§çš„ IO æˆ‘ä¹Ÿæ˜¯é¢†æ•™è¿‡çš„ï¼Œä¹‹å‰ç”¨æ¥æŒ‚ PTï¼Œå†™å…¥é€Ÿåº¦è¿˜æ²¡æˆ‘å®¶ 200M ç½‘é€Ÿå¿«ï¼Œæ‹¿æ¥ç›´æ¥è¯»ç¡¬åº¦ç¡¬ç›˜è‚¯å®šæ˜¯æ¯”è¾ƒè›‹ç–¼çš„ï¼Œè€Œä¸”æ ‘è“æ´¾ä¾›ç”µä¹Ÿå¸¦ä¸åŠ¨ï¼Œé‚£æ€ä¹ˆåŠå‘¢ã€‚å®¶é‡Œçš„è·¯ç”±å™¨æ˜¯åç¡•çš„ AC86Uï¼Œå°±ç”¨è·¯ç”±å™¨å¸¦ç¡¬ç›˜å§ï¼Œ40M IO å·®ä¸å¤šå§ï¼Œåšç½‘ç›˜è‚¯å®šæ˜¯å¤Ÿäº†ã€‚

* å…·ä½“å®æ–½
** æ ‘è“æ´¾ç³»ç»Ÿ
æˆ‘éƒ½æ‡’å¾—é‡æ–°è£…äº†ï¼Œæ’ä¸Šä¹‹å‰çš„ tf å¡ç›´æ¥å¼€å¹²

** è·¯ç”±å™¨åˆ†äº«æ–‡ä»¶ç³»ç»Ÿæµ‹è¯•
æˆ‘æ²¡æœ‰å‚»åˆ°æœ€åä¸€æ­¥æ‰ç”¨æ ‘è“æ´¾æ¥å…¥è·¯ç”±å™¨åˆ†äº«å‡ºæ¥çš„æ–‡ä»¶ç³»ç»Ÿ

å…ˆæŠŠç¡¬ç›˜æ€¼åˆ°æˆ‘è·¯ç”±å™¨åé¢çš„ USB3.0 æ¥å£ä¸Šï¼Œç™»é™†è·¯ç”±å™¨ç®¡ç†é¡µé¢ï¼Œèƒ½ç›´æ¥çœ‹åˆ°å·²ç»è¯†åˆ«åˆ°äº†ç¡¬ç›˜ï¼Œè¿˜æ˜¯æŒºé¡ºåˆ©çš„

ç„¶åå‡†å¤‡æŠŠè¿™ä¸ªç¡¬ç›˜åˆ†äº«å‡ºå»ï¼Œé‰´äºä¹‹å‰æˆ‘è¯•è¿‡æ ‘è“æ´¾ mount samba åè®®çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ­»æ´»ä¸æˆåŠŸï¼Œæ‰€ä»¥æˆ‘è¿™æ¬¡é€‰æ‹©ç”¨ nfs åè®®

å‚ç…§è¿™ä¸ªæ–‡ç«  https://sysadmins.co.za/setup-a-nfs-server-and-client-on-the-raspberry-pi/, åœ¨è·¯ç”±å™¨ä¸Šè®¾ç½®äº†ä¹‹ååˆ°æ ‘è“æ´¾ä¸Šå» mount 

ä¸»è¦æ˜¯è¦åœ¨ nfs æœåŠ¡å™¨ä¸ŠåŠ ä¸Š sync è¿™ä¸ªé…ç½®ï¼Œä¸ç„¶çš„è¯ï¼Œåœ¨ nfs å®¢æˆ·ç«¯è¯»å–æ•°æ®ä¼šæŠ¥æƒé™é—®é¢˜ï¼Œåœ¨åç¡•è·¯ç”±å™¨ AC86U ä¸Šçš„é…ç½®å¦‚ä¸‹

[[image-url:./æ ‘è“æ´¾éƒ¨ç½² seafile å’Œ nextcloud æ¯”è¾ƒ/7bddd2684fef60f639a70d236479416d]]

ç„¶ååœ¨æ ‘è“æ´¾ä¸Šé‡æ–°çš„æŒ‚è½½å‘½ä»¤å¦‚ä¸‹

#+BEGIN_SRC
sudo mount -o rw 192.168.50.1:/mnt/Storage/NFS /mnt/nfs
#+END_SRC

ç„¶ååœ¨ /mnt/nfs ä¸‹è¯»å†™äº†ä¸€ä¸‹ï¼Œéƒ½æ˜¯æ­£å¸¸çš„ï¼Œè€Œä¸”æƒé™æ­£ç¡®ï¼Œç”¨æˆ·åæ˜¯ pi

** å®‰è£… seafileï¼Œ nextcloud

*** å…ˆå®‰è£… docker
åœ¨ docker å®˜ç½‘æ–‡æ¡£ä¸Š
[[https://docs.docker.com/install/linux/docker-ee/ubuntu/]]

åœ¨ =Install using the convenience script= è¿™ä¸ªç« èŠ‚é‡Œï¼Œæ‹·è´è¿™æ®µä»£ç æ‰§è¡Œå°± ok äº†ï¼Œååˆ†ç®€å•

#+BEGIN_SRC bash
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
#+END_SRC

*** å®‰è£… mysql 
å› ä¸º seafile å’Œ nextcloud éƒ½è¦ç”¨åˆ° mysqlï¼Œ æ‰€ä»¥è¦å…ˆå®‰è£…  mysql ï¼Œå‡†å¤‡ç”¨ docker å¯åŠ¨ä¸€ä¸ªï¼Œ*ä½†æ˜¯ docker çš„ mysql é•œåƒæ²¡æœ‰ arm æ¶æ„é›†*ï¼Œæ— æ³•è¿è¡Œ

äºæ˜¯åœ¨æ ‘è“ä¸Šç”¨ apt install mysql æ¥å®‰è£…ï¼Œç„¶åæ‰å‘ç°æˆ‘ä¹‹å‰åœ¨æ ‘è“æ´¾ä¸Šå®‰è£…è¿‡ï¼Œä½†æ˜¯ root å¯†ç å¿˜äº†ï¼Œæˆ‘ä¹Ÿå°±ä½œç½¢äº†ï¼Œæˆ‘è®°å¾— mysql æ”¹å¯†ç è¿˜æŒºéº»çƒ¦çš„ï¼Œseafile å’Œ nextcloud éƒ½æ”¯æŒ sqlite3ï¼Œé‚£å°±å…ˆç”¨ sqlite3 å§ï¼Œä»¥åå†æƒ³åŠæ³•è¿ç§»åˆ° mysql


*** å®‰è£… seafile
ä¸€å¼€å§‹å®‰è£… seafile çš„æ—¶å€™æˆ‘æ˜¯æƒ³ç›´æ¥ç”¨ docker å¯åŠ¨çš„ï¼Œä½†æ˜¯ä¸€è¿è¡Œå‘ç°ä¸è¡Œï¼Œseafile æ²¡æœ‰ç¼–è¯‘ arm æ¶æ„çš„ï¼Œé‚£æ²¡åŠæ³•äº†ï¼Œåªèƒ½æ‰‹å·¥å®‰è£…ï¼Œåªæ˜¯å¤ªéº»çƒ¦äº†ã€‚

#+BEGIN_QUOTE
ps: docker å®åœ¨çœŸçš„æ˜¯å¤ªæ–¹ä¾¿äº†
#+END_QUOTE

ç°åœ¨å®˜ç½‘æ–‡æ¡£ä¸­ [[http://www.seafile.com/en/download/#server]] æ‰¾åˆ°æ ‘è“æ´¾ç¼–è¯‘å¥½çš„åŒ…ï¼Œç„¶åæŒ‰ç…§ =Deploying Seafile with SQLite= è¿™ä¸ªç« èŠ‚çš„æ•™ç¨‹ï¼Œå¼€å§‹éƒ¨ç½² seafile

éƒ¨ç½²æ“ä½œè¿˜æ˜¯ç®—ç®€å•çš„ï¼Œåº”è¯¥æ²¡æœ‰ä»€ä¹ˆéš¾åº¦ï¼Œå”¯ä¸€æ„Ÿè§‰æœ‰ç‚¹ä¸”æƒ³åæ§½çš„æ˜¯ï¼Œseafile å¯åŠ¨è¦å¯åŠ¨ä¸¤ä¸ªä¸œè¥¿ï¼Œä¸€ä¸ªæ˜¯ seafileï¼Œä¸€ä¸ªæ˜¯ seahubï¼Œè€Œåœ¨é…ç½®é¡¹é‡Œé¢åªæœ‰ seahub service çš„ç«¯å£é…ç½®ï¼Œè™½ç„¶æ–‡æ¡£é‡Œæœ‰è¯´æ˜ï¼Œä½†æ˜¯è¿˜æ˜¯å¾ˆå®¹æ˜“è¯¯å¯¼äººï¼Œæˆ‘å°±æäº†åŠå¤©å‘ç° 8001 ä¸æ˜¯ web ç«¯å£ï¼Œæ— è¯­ğŸ˜“

æŠŠ seafile å¯åŠ¨äº†ä¹‹åï¼Œå‘ç° seafile æœåŠ¡æ­£å¸¸ï¼Œadmin è´¦å·æˆåŠŸç™»å½•å’Œä¸ŠåºŠæ–‡ä»¶ï¼Œç®—æ˜¯æˆåŠŸäº†

*** mount nfs é—®é¢˜ã€‚

å½“ç„¶ä¸Šä¸€æ­¥åªæ˜¯ seafile æœåŠ¡å¯åŠ¨æˆåŠŸäº†ï¼Œç”¨çš„ç©ºé—´æ˜¯æ ‘è“æ´¾çš„ TF å¡ç©ºé—´ï¼Œé‚£ io é€Ÿåº¦éå¸¸æ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç”¨ NTF æŒ‚è½½çš„ç³»ç»Ÿï¼Œé‚£ä¹ˆæˆ‘ä»¬åˆ° =conf/seafile.conf= ä¸Šï¼Œä¿®æ”¹æ•°æ®ç›®å½•å­˜å‚¨ç©ºé—´åˆ°æˆ‘ä»¬æŒ‚è½½çš„ /mnt/ntf/seafile ä¸Šï¼Œä½†æ˜¯æœ€å‘çš„äº‹æƒ…æ¥äº†



*database lock*

å½“åˆ‡æ¢äº†å­˜å‚¨ç›®å½•ï¼Œå¹¶é‡æ–°å¯åŠ¨åï¼Œå‘ç°æ•°æ®åº“è¢«é”å®šäº†ğŸ”’

#+BEGIN_SRC bash
[03/16/19 23:00:58] ../common/seaf-db.c(142): Error exec query CREATE TABLE IF NOT EXISTS Branch (name VARCHAR(10), repo_id CHAR(41), commit_id CHAR(41),PRIMARY KEY (repo_id, name)): sqlite3_exec failed: database is locked.
#+END_SRC

ä»”ç»†æƒ³æƒ³ï¼Œè¢«é”å®šäº†ï¼Œé‚£ä¼°è®¡å°±æ˜¯ nfs ä¸‹çš„ sqlite3 æ–‡ä»¶ç³»ç»Ÿæœ‰é—®é¢˜å‘—ï¼Œä½†æ˜¯ä¹Ÿæ²¡ç†ç”±ä¸ç”¨ nfs å•Šï¼Œæ ‘è“æ´¾çš„ tf å¡é‚£ä¹ˆå°ï¼Œå‡ ä¹ä¸èƒ½å­˜å‚¨ä¸œè¥¿å•Š

äºæ˜¯ä¸Šç½‘æŸ¥é˜…äº†ä¸€ä¸‹ï¼Œæœç„¶æœ‰å“¥ä»¬é‡åˆ°äº†åŒæ ·çš„é—®é¢˜ï¼Œåªéœ€è¦åœ¨ mount çš„æ—¶å€™åŠ ä¸Š =nolock= å°±èƒ½å®Œç¾è§£å†³

sudo mount  192.168.50.1:/mnt/sda1/nfs /mnt/remote -o user=pi,nolock

è§£å†³äº†ä¹‹åï¼Œåœ¨æ ‘è“æ´¾ä¸Šçš„ seafile å°±å·²ç»è¿è¡Œçš„å¾ˆæˆåŠŸäº†ã€‚

#+BEGIN_SRC bash
[2019-03-16T23:57:17,259][INFO ][o.e.c.s.MasterService    ] [node-raspberry] zen-disco-elected-as-master ([0] nodes joined), reason: new_master {node-raspberry}{UEpNAPb5Rqyeeox4J1d1mQ}{yXcpPUV7Q12Q-ZcuA3QBLQ}{172.17.0.1}{172.17.0.1:9300}{xpack.installed=true}
[2019-03-16T23:57:17,287][INFO ][o.e.c.s.ClusterApplierService] [node-raspberry] new_master {node-raspberry}{UEpNAPb5Rqyeeox4J1d1mQ}{yXcpPUV7Q12Q-ZcuA3QBLQ}{172.17.0.1}{172.17.0.1:9300}{xpack.installed=true}, reason: apply cluster state (from master [master {node-raspberry}{UEpNAPb5Rqyeeox4J1d1mQ}{yXcpPUV7Q12Q-ZcuA3QBLQ}{172.17.0.1}{172.17.0.1:9300}{xpack.installed=true} committed version [1] source [zen-disco-elected-as-master ([0] nodes joined)]])
[2019-03-16T23:57:17,674][INFO ][o.e.h.n.Netty4HttpServerTransport] [node-raspberry] publish_address {172.17.0.1:9200}, bound_addresses {[::]:9200}
[2019-03-16T23:57:17,678][INFO ][o.e.n.Node               ] [node-raspberry] started
[2019-03-16T23:57:19,020][WARN ][o.e.x.s.a.s.m.NativeRoleMappingStore] [node-raspberry] Failed to clear cache for realms [[]]
[2019-03-16T23:57:20,018][INFO ][o.e.g.GatewayService     ] [node-raspberry] recovered [0] indices into cluster_state
[2019-03-16T23:57:21,410][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-raspberry] adding template [.triggered_watches] for index patterns [.triggered_watches*]
[2019-03-16T23:57:21,732][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-raspberry] adding template [.watches] for index patterns [.watches*]
[2019-03-16T23:57:23,179][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-raspberry] adding template [.watch-history-9] for index patterns [.watcher-history-9*]
[2019-03-16T23:57:24,309][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-raspberry] adding template [.monitoring-logstash] for index patterns [.monitoring-logstash-6-*]
[2019-03-16T23:57:25,893][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-raspberry] adding template [.monitoring-es] for index patterns [.monitoring-es-6-*]
[2019-03-16T23:57:27,062][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-raspberry] adding template [.monitoring-beats] for index patterns [.monitoring-beats-6-*]
[2019-03-16T23:57:29,280][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-raspberry] adding template [.monitoring-alerts] for index patterns [.monitoring-alerts-6]
[2019-03-16T23:57:30,642][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-raspberry] adding template [.monitoring-kibana] for index patterns [.monitoring-kibana-6-*]
[2019-03-16T23:57:33,935][INFO ][o.e.l.LicenseService     ] [node-raspberry] license [74bc854c-2bc2-4ab0-a639-38d37aa3d155] mode [basic] - valid
#+END_SRC


*** frp client

seafile å¦‚æœåªåœ¨å†…ç½‘ä¸Šèƒ½ç”¨ï¼Œä¹Ÿå¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆç©å¤´ï¼Œè€Œä¸” seafile å’Œ nextcloud éƒ½æ”¯æŒæ‰‹æœºç«¯å’Œç”µè„‘ç«¯ï¼Œä½†æ˜¯æˆ‘å®¶çš„å®½å¸¦æ˜¯åŠ¨æ€è·å– ip çš„ï¼Œä¹Ÿå°±æ˜¯å¤„äº NAT ä¸‹ï¼Œè€Œä¸”ç»è¿‡æˆ‘æ£€æŸ¥ï¼Œå¤„åœ¨äº†å¤šå±‚ NAT ä¸‹ï¼Œé‚£ä¹ˆå°±æ— æ³•ç”¨è¿‡ DDNS ç»‘å®šæˆ‘å®¶å®½å¸¦çš„åŠ¨æ€ ip äº†ï¼Œé‚£ä¹ˆåªèƒ½é€šè¿‡å†…ç½‘ç©¿é€æŠ€æœ¯æŠŠå†…ç½‘çš„ seafile æœåŠ¡æš´éœ²åˆ°å¤–ç½‘ä¸Š

#+BEGIN_QUOTE
vi /etc/systemd/system/frps.service æ–°å»ºæ­¤æ–‡ä»¶ï¼Œå¹¶å†™å…¥ä»¥ä¸‹å†…å®¹

#+BEGIN_QUOTE
[Unit]
Description=frps daemon

[Service]
Type=simple
ExecStart=/usr/bin/frps -c /etc/frps/frps.ini

[Install]
WantedBy=multi-user.target
#+END_QUOTE


å¯åŠ¨å¹¶è®¾ä¸ºå¼€æœºè‡ªå¯ã€‚

$ systemctl start frps
$ systemctl enable frps

#+END_QUOTE


ç„¶åæŒ‰ç…§æ–‡æ¡£é…ç½®æ–‡ä»¶ï¼š

#+BEGIN_SRC yaml
[seafile]
type = tcp
local_ip = 192.168.50.xx
local_port = 8081
remote_port = 6600

#+END_SRC

ç„¶åé‡å¯ frpï¼Œ åœ¨æœ‰å…¬ç½‘ ip çš„æœåŠ¡å™¨çš„ 127.0.0.1:6600 å·²ç»å¯¹æ¥ä¸Šäº† seafile çš„ web æœåŠ¡ã€‚


*** nginx åå‘ä»£ç†

æœ€åä¸€æ­¥ï¼Œå°±æ˜¯åœ¨ vps ä¸Šæ·»åŠ åå‘ä»£ç†äº†ï¼š

è¿™ä¸ª seafile çš„è§„åˆ™è¿˜æ¯”è¾ƒç‰¹æ®Šï¼Œæˆ‘æ˜¯å‚é˜…äº† seafile çš„å®˜æ–¹æ–‡æ¡£é…ç½®çš„

#+BEGIN_SRC nginx
server {
    listen 443 ssl http2;
    server_name xx.xx.com.xyz;
    access_log off;

    ssl_certificate /etc/letsencrypt/live/xx.xx.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xx.xx.com/privkey.pem;

    location / {
         proxy_pass         http://seafile_upstream;
         proxy_set_header   Host $host;
         proxy_set_header   X-Real-IP $remote_addr;
         proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_set_header   X-Forwarded-Host $server_name;
         proxy_read_timeout  1200s;

         # used for view/edit office file via Office Online Server
    }

    location /seafhttp {
        proxy_pass http://seafile_upstream/seafhttp/;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_connect_timeout  36000s;
        proxy_read_timeout  36000s;
        proxy_send_timeout  36000s;

        client_max_body_size 0;
        send_timeout  36000s;
    }
}
#+END_SRC


** å®‰è£… nextcloud 

ç›¸æ¯” seafile ä¹‹ä¸‹ï¼Œnextcloud çš„å®‰è£…å¯è°“ååˆ†ç®€å•
#+BEGIN_SRC
docker run -d -p 8080:80 -v /mnt/nfs/nextcloud:/var/www/html nextcloud
#+END_SRC

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œnextcloud çš„æ•°æ®ç›®å½•æŒ‚è½½çš„ nfs åŒæ ·éœ€è¦ nolock çš„æŒ‚è½½å‚æ•°ï¼Œä¸ç„¶ä¸€æ ·å¯åŠ¨ä¸äº†ã€‚


* seafile å’Œ nextcloud çš„ä½¿ç”¨å¯¹æ¯”

** seafile 
ä¼˜ç‚¹ï¼š
1. ä¸­æ–‡æ”¯æŒ
2. ç¤¾åŒºè¿˜ç®—ä¸°å¯Œ
3. å®¢æˆ·ç«¯å¤šï¼Œæ”¯æŒä¸°å¯Œï¼Œè¿˜æœ‰ linux ç‰ˆæœ¬çš„åŒæ­¥å®¢æˆ·ç«¯

ç¼ºç‚¹ï¼š

1.bugå¤šï¼ˆiosï¼Œandroid éƒ½æœ‰åŒæ­¥ç›¸ç‰‡ç­‰bugï¼‰
2.åŠŸèƒ½ä¸å¤š
3. ä¸€äº›è®¾è®¡ä¸å¤ªåˆç†ï¼ˆä¾‹å¦‚éœ€è¦ç»‘å®šä¸€ä¸ªåŸŸåï¼Œseahubä¸Šä¼ åœ°å€å›ºå®šç­‰ï¼‰

** nextcloud
ä¼˜ç‚¹ï¼š
1. å¥½çœ‹ï¼Œè®¾è®¡å¤§æ–¹ç®€ä»‹
2. åŠŸèƒ½å¤š
3. ç›¸æ¯” seafile è®¾è®¡åˆç†

ç¼ºç‚¹ï¼š
1. mac å®¢æˆ·ç«¯å¤ªä¸‘

æ€»çš„æ¥è¯´ï¼Œå…¶å® nextcloud æ˜¯æ¯” seafile æ›´å¥½çš„ï¼Œä½†æ˜¯ä»¤æˆ‘æ— æ³•å¿å—çš„æ˜¯ nextcloud çš„ mac å®¢æˆ·ç«¯å¤ªä¸‘äº†ï¼Œç®€ç›´æ˜¯ä¸Šä¸ªå¹´ä»£äº§ç‰©ï¼Œæ— å¥ˆä¹‹ä¸‹æˆ‘åªèƒ½é€‰æ‹©äº† seafile ä½œä¸ºæ­£å¼ä½¿ç”¨çš„ç½‘ç›˜ã€‚
